{% extends "layout.html" %}

{% block title %}{{ title }} - EventSync{% endblock %}

{% block extra_css %}
<style>
    .analytics-container {
        padding: 20px 0;
    }
    
    .dashboard-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 40px 20px;
        border-radius: 15px;
        margin-bottom: 30px;
        text-align: center;
    }
    
    .dashboard-header h1 {
        margin: 0;
        font-size: 2.5em;
        font-weight: 300;
    }
    
    .dashboard-header p {
        margin: 10px 0 0 0;
        opacity: 0.9;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 40px;
    }
    
    .stat-card {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        transition: transform 0.3s ease;
        text-align: center;
    }
    
    .stat-card:hover {
        transform: translateY(-5px);
    }
    
    .stat-icon {
        font-size: 2.5em;
        margin-bottom: 15px;
        display: block;
    }
    
    .stat-number {
        font-size: 2.2em;
        font-weight: bold;
        margin: 10px 0;
        color: #333;
    }
    
    .stat-label {
        color: #666;
        font-size: 1em;
        font-weight: 500;
    }
    
    .stat-growth {
        font-size: 0.9em;
        margin-top: 10px;
        padding: 5px 10px;
        border-radius: 15px;
    }
    
    .growth-positive {
        background: #d4edda;
        color: #155724;
    }
    
    .growth-negative {
        background: #f8d7da;
        color: #721c24;
    }
    
    .charts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
        gap: 30px;
        margin: 40px 0;
    }
    
    .chart-card {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .chart-card h3 {
        margin: 0 0 20px 0;
        color: #333;
        font-size: 1.3em;
        font-weight: 600;
    }
    
    .chart-container {
        position: relative;
        height: 300px;
    }
    
    .tables-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 30px;
        margin: 40px 0;
    }
    
    .table-card {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .table-card h3 {
        margin: 0 0 20px 0;
        color: #333;
        font-size: 1.3em;
        font-weight: 600;
    }
    
    .data-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .data-table th,
    .data-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #eee;
    }
    
    .data-table th {
        background: #f8f9fa;
        font-weight: 600;
        color: #495057;
    }
    
    .loading {
        text-align: center;
        padding: 40px;
        color: #666;
    }
    
    .loading-spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid #667eea;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .export-section {
        text-align: center;
        margin: 40px 0;
        padding: 30px;
        background: white;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .btn-export {
        background: linear-gradient(45deg, #28a745, #20c997);
        color: white;
        border: none;
        padding: 12px 25px;
        border-radius: 25px;
        margin: 0 10px;
        cursor: pointer;
        transition: transform 0.3s;
    }
    
    .btn-export:hover {
        transform: translateY(-2px);
    }
    
    .refresh-btn {
        position: fixed;
        bottom: 30px;
        right: 30px;
        background: #667eea;
        color: white;
        border: none;
        padding: 15px;
        border-radius: 50%;
        font-size: 1.2em;
        cursor: pointer;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        transition: transform 0.3s;
    }
    
    .refresh-btn:hover {
        transform: scale(1.1);
    }
</style>
{% endblock %}

{% block content %}
<div class="analytics-container">
    <div class="container">
        <div class="dashboard-header">
            <h1>üìä Analytics Dashboard</h1>
            <p>Comprehensive insights into your events, users, and performance</p>
        </div>
        
        <!-- Overview Stats -->
        <div class="stats-grid" id="overview-stats">
            <div class="loading">
                <div class="loading-spinner"></div>
                Loading overview statistics...
            </div>
        </div>
        
        <!-- Charts Section -->
        <div class="charts-grid">
            <!-- Event Trends Chart -->
            <div class="chart-card">
                <h3>üìà Event Trends (Last 12 Months)</h3>
                <div class="chart-container">
                    <canvas id="eventTrendsChart"></canvas>
                </div>
            </div>
            
            <!-- Category Distribution -->
            <div class="chart-card">
                <h3>üè∑Ô∏è Event Categories</h3>
                <div class="chart-container">
                    <canvas id="categoryChart"></canvas>
                </div>
            </div>
            
            <!-- Ticket Sales -->
            <div class="chart-card">
                <h3>üé´ Daily Ticket Sales (Last 30 Days)</h3>
                <div class="chart-container">
                    <canvas id="ticketSalesChart"></canvas>
                </div>
            </div>
            
            <!-- User Registrations -->
            <div class="chart-card">
                <h3>üë• User Registrations</h3>
                <div class="chart-container">
                    <canvas id="userRegistrationsChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Data Tables -->
        <div class="tables-grid">
            <!-- Popular Events -->
            <div class="table-card">
                <h3>üåü Most Popular Events</h3>
                <div id="popular-events-table">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        Loading popular events...
                    </div>
                </div>
            </div>
            
            <!-- Top Revenue Events -->
            <div class="table-card">
                <h3>üí∞ Top Revenue Events</h3>
                <div id="revenue-events-table">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        Loading revenue data...
                    </div>
                </div>
            </div>
            
            <!-- Active Users -->
            <div class="table-card">
                <h3>üöÄ Most Active Users</h3>
                <div id="active-users-table">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        Loading user data...
                    </div>
                </div>
            </div>
            
            <!-- Performance Metrics -->
            <div class="table-card">
                <h3>üìä Event Performance</h3>
                <div id="performance-table">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        Loading performance metrics...
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Export Section -->
        <div class="export-section">
            <h3>üì§ Export Analytics</h3>
            <p>Download your analytics data in various formats</p>
            <button class="btn-export" onclick="exportData('json')">üìÑ Export JSON</button>
            <button class="btn-export" onclick="exportData('csv')">üìä Export CSV</button>
            <button class="btn-export" onclick="exportData('excel')">üìà Export Excel</button>
        </div>
    </div>
    
    <!-- Refresh Button -->
    <button class="refresh-btn" onclick="refreshAllData()" title="Refresh Data">
        üîÑ
    </button>
</div>

<script>
let charts = {};

document.addEventListener('DOMContentLoaded', function() {
    loadAllAnalytics();
});

async function loadAllAnalytics() {
    try {
        // Load all analytics data
        await Promise.all([
            loadOverviewStats(),
            loadEventStats(),
            loadTicketAnalytics(),
            loadUserInsights(),
            loadPerformanceMetrics()
        ]);
        
        console.log('‚úÖ All analytics loaded successfully');
    } catch (error) {
        console.error('‚ùå Error loading analytics:', error);
    }
}

async function loadOverviewStats() {
    try {
        const response = await fetch('/analytics/api/overview');
        const result = await response.json();
        
        if (result.success) {
            renderOverviewStats(result.data);
        } else {
            throw new Error(result.message);
        }
    } catch (error) {
        document.getElementById('overview-stats').innerHTML = `
            <div class="stat-card" style="grid-column: 1/-1;">
                <div class="text-danger">Error loading overview stats: ${error.message}</div>
            </div>
        `;
    }
}

function renderOverviewStats(data) {
    const statsHtml = `
        <div class="stat-card">
            <span class="stat-icon">üéâ</span>
            <div class="stat-number">${data.total_events}</div>
            <div class="stat-label">Total Events</div>
            <div class="stat-growth growth-${data.event_growth >= 0 ? 'positive' : 'negative'}">
                ${data.event_growth >= 0 ? '+' : ''}${data.event_growth}% this month
            </div>
        </div>
        <div class="stat-card">
            <span class="stat-icon">üé´</span>
            <div class="stat-number">${data.total_tickets}</div>
            <div class="stat-label">Total Tickets</div>
            <div class="stat-growth growth-positive">
                ${data.recent_tickets} in last 30 days
            </div>
        </div>
        <div class="stat-card">
            <span class="stat-icon">üí∞</span>
            <div class="stat-number">$${data.total_revenue}</div>
            <div class="stat-label">Total Revenue</div>
        </div>
        <div class="stat-card">
            <span class="stat-icon">üë•</span>
            <div class="stat-number">${data.total_users}</div>
            <div class="stat-label">Total Users</div>
            <div class="stat-growth growth-positive">
                ${data.total_attendees} attendees, ${data.total_organizers} organizers
            </div>
        </div>
        <div class="stat-card">
            <span class="stat-icon">üìÖ</span>
            <div class="stat-number">${data.active_events}</div>
            <div class="stat-label">Upcoming Events</div>
        </div>
    `;
    
    document.getElementById('overview-stats').innerHTML = statsHtml;
}

async function loadEventStats() {
    try {
        const response = await fetch('/analytics/api/event-stats');
        const result = await response.json();
        
        if (result.success) {
            renderEventCharts(result.data);
        } else {
            throw new Error(result.message);
        }
    } catch (error) {
        console.error('Error loading event stats:', error);
    }
}

function renderEventCharts(data) {
    // Event Trends Chart
    const trendsCtx = document.getElementById('eventTrendsChart').getContext('2d');
    charts.eventTrends = new Chart(trendsCtx, {
        type: 'line',
        data: {
            labels: data.monthly_events.map(item => item.month),
            datasets: [{
                label: 'Events Created',
                data: data.monthly_events.map(item => item.count),
                borderColor: '#667eea',
                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
    
    // Category Distribution Chart
    const categoryCtx = document.getElementById('categoryChart').getContext('2d');
    charts.category = new Chart(categoryCtx, {
        type: 'doughnut',
        data: {
            labels: data.category_distribution.map(item => item.category),
            datasets: [{
                data: data.category_distribution.map(item => item.count),
                backgroundColor: [
                    '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
                    '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
    
    // Render popular events table
    renderPopularEventsTable(data.popular_events);
}

async function loadTicketAnalytics() {
    try {
        const response = await fetch('/analytics/api/ticket-analytics');
        const result = await response.json();
        
        if (result.success) {
            renderTicketCharts(result.data);
        } else {
            throw new Error(result.message);
        }
    } catch (error) {
        console.error('Error loading ticket analytics:', error);
    }
}

function renderTicketCharts(data) {
    // Daily Ticket Sales Chart
    const salesCtx = document.getElementById('ticketSalesChart').getContext('2d');
    charts.ticketSales = new Chart(salesCtx, {
        type: 'bar',
        data: {
            labels: data.daily_sales.map(item => item.date),
            datasets: [{
                label: 'Tickets Sold',
                data: data.daily_sales.map(item => item.tickets),
                backgroundColor: 'rgba(40, 167, 69, 0.8)',
                borderColor: '#28a745',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
    
    // Render revenue events table
    renderRevenueEventsTable(data.revenue_by_event);
}

async function loadUserInsights() {
    try {
        const response = await fetch('/analytics/api/user-insights');
        const result = await response.json();
        
        if (result.success) {
            renderUserCharts(result.data);
        } else {
            throw new Error(result.message);
        }
    } catch (error) {
        console.error('Error loading user insights:', error);
    }
}

function renderUserCharts(data) {
    // User Registrations Chart
    const userCtx = document.getElementById('userRegistrationsChart').getContext('2d');
    charts.userRegistrations = new Chart(userCtx, {
        type: 'line',
        data: {
            labels: data.monthly_registrations.map(item => item.month),
            datasets: [{
                label: 'New Users',
                data: data.monthly_registrations.map(item => item.count),
                borderColor: '#17a2b8',
                backgroundColor: 'rgba(23, 162, 184, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
    
    // Render active users table
    renderActiveUsersTable(data.most_active_users);
}

async function loadPerformanceMetrics() {
    try {
        const response = await fetch('/analytics/api/performance-metrics');
        const result = await response.json();
        
        if (result.success) {
            renderPerformanceTable(result.data.event_performance);
        } else {
            throw new Error(result.message);
        }
    } catch (error) {
        console.error('Error loading performance metrics:', error);
    }
}

function renderPopularEventsTable(data) {
    if (!data || data.length === 0) {
        document.getElementById('popular-events-table').innerHTML = '<p>No event data available</p>';
        return;
    }
    
    let tableHtml = `
        <table class="data-table">
            <thead>
                <tr>
                    <th>Event</th>
                    <th>Tickets Sold</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    data.forEach(item => {
        tableHtml += `
            <tr>
                <td>${item.event}</td>
                <td>${item.tickets}</td>
            </tr>
        `;
    });
    
    tableHtml += `
            </tbody>
        </table>
    `;
    
    document.getElementById('popular-events-table').innerHTML = tableHtml;
}

function renderRevenueEventsTable(data) {
    if (!data || data.length === 0) {
        document.getElementById('revenue-events-table').innerHTML = '<p>No revenue data available</p>';
        return;
    }
    
    let tableHtml = `
        <table class="data-table">
            <thead>
                <tr>
                    <th>Event</th>
                    <th>Revenue</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    data.forEach(item => {
        tableHtml += `
            <tr>
                <td>${item.event}</td>
                <td>$${item.revenue.toFixed(2)}</td>
            </tr>
        `;
    });
    
    tableHtml += `
            </tbody>
        </table>
    `;
    
    document.getElementById('revenue-events-table').innerHTML = tableHtml;
}

function renderActiveUsersTable(data) {
    if (!data || data.length === 0) {
        document.getElementById('active-users-table').innerHTML = '<p>No user data available</p>';
        return;
    }
    
    let tableHtml = `
        <table class="data-table">
            <thead>
                <tr>
                    <th>Username</th>
                    <th>Tickets</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    data.forEach(item => {
        tableHtml += `
            <tr>
                <td>${item.username}</td>
                <td>${item.tickets}</td>
            </tr>
        `;
    });
    
    tableHtml += `
            </tbody>
        </table>
    `;
    
    document.getElementById('active-users-table').innerHTML = tableHtml;
}

function renderPerformanceTable(data) {
    if (!data || data.length === 0) {
        document.getElementById('performance-table').innerHTML = '<p>No performance data available</p>';
        return;
    }
    
    let tableHtml = `
        <table class="data-table">
            <thead>
                <tr>
                    <th>Event</th>
                    <th>Tickets</th>
                    <th>Revenue</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    data.slice(0, 5).forEach(item => {
        tableHtml += `
            <tr>
                <td>${item.event}</td>
                <td>${item.tickets_sold}</td>
                <td>$${item.revenue.toFixed(2)}</td>
            </tr>
        `;
    });
    
    tableHtml += `
            </tbody>
        </table>
    `;
    
    document.getElementById('performance-table').innerHTML = tableHtml;
}

function exportData(format) {
    const exportUrl = `/analytics/export/${format}`;
    
    fetch(exportUrl)
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                if (format === 'json') {
                    // Download JSON data
                    const blob = new Blob([JSON.stringify(result.data, null, 2)], {
                        type: 'application/json'
                    });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = result.filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }
                
                alert(`‚úÖ Analytics exported successfully as ${format.toUpperCase()}`);
            } else {
                alert(`‚ùå Export failed: ${result.message}`);
            }
        })
        .catch(error => {
            alert(`‚ùå Export error: ${error.message}`);
        });
}

function refreshAllData() {
    // Destroy existing charts
    Object.values(charts).forEach(chart => {
        if (chart) {
            chart.destroy();
        }
    });
    charts = {};
    
    // Show loading states
    document.getElementById('overview-stats').innerHTML = `
        <div class="loading" style="grid-column: 1/-1;">
            <div class="loading-spinner"></div>
            Refreshing data...
        </div>
    `;
    
    // Reload all analytics
    loadAllAnalytics();
}
</script>
{% endblock %}
